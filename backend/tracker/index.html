<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#000000">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="manifest" href="manifest.json">
  <title>System Service</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #000;
      color: #333;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .container {
      text-align: center;
      padding: 20px;
      max-width: 400px;
    }
    .status {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: #1a1a1a;
      margin: 0 auto 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
    }
    .status.active { background: #064e3b; }
    .status.connecting { background: #1e3a5f; }
    .status.error { background: #5c1a1a; }
    .status.download { background: #1e3a5f; }
    h1 { color: #666; font-size: 18px; font-weight: 500; margin-bottom: 8px; }
    p { color: #444; font-size: 14px; line-height: 1.6; }
    .btn {
      background: #1a1a1a;
      color: #888;
      border: none;
      padding: 12px 32px;
      border-radius: 8px;
      font-size: 14px;
      margin-top: 20px;
      cursor: pointer;
      display: none;
    }
    .btn:hover { background: #2a2a2a; }
    .btn.show { display: inline-block; }
    .install-prompt {
      position: fixed;
      bottom: 20px;
      left: 20px;
      right: 20px;
      background: #1a1a1a;
      padding: 16px;
      border-radius: 12px;
      display: none;
    }
    .install-prompt.show { display: block; }
    .install-prompt p { color: #888; margin-bottom: 12px; }
    .install-btn {
      background: #333;
      color: #aaa;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      width: 100%;
      cursor: pointer;
    }
    .steps { text-align: left; margin-top: 16px; }
    .steps li { color: #555; margin: 8px 0; font-size: 13px; }
    .android-download { display: none; }
    .android-download.show { display: block; }
  </style>
</head>
<body>
  <!-- Android Download View -->
  <div class="container android-download" id="androidView">
    <div class="status download">ðŸ“²</div>
    <h1>Install Tracker App</h1>
    <p>Download and install for background tracking</p>
    <a href="https://github.com/kbweeb/embedded-systems-project/releases/latest/download/app-release.apk" 
       class="btn show" 
       id="downloadBtn"
       style="display:inline-block;text-decoration:none;">
      Download App
    </a>
    <ol class="steps">
      <li>Tap the downloaded file in notifications</li>
      <li>Tap "Install" (enable unknown sources if asked)</li>
      <li>Open app and enter your name</li>
      <li>Select "Allow all the time" for location</li>
    </ol>
  </div>

  <!-- PWA View (iOS/Desktop fallback) -->
  <div class="container" id="pwaView">
    <div class="status connecting" id="status">âš¡</div>
    <h1 id="title">Initializing...</h1>
    <p id="message">Please wait</p>
    <button class="btn" id="enableBtn" onclick="requestPermission()">Enable Service</button>
  </div>
  
  <div class="install-prompt" id="installPrompt">
    <p>Add to Home Screen for best experience</p>
    <button class="install-btn" id="installBtn">Install</button>
  </div>

  <script>
    const isAndroid = /Android/i.test(navigator.userAgent);
    const APK_URL = 'https://github.com/kbweeb/embedded-systems-project/releases/latest/download/app-release.apk';
    
    if (isAndroid) {
      document.getElementById('androidView').classList.add('show');
      document.getElementById('pwaView').style.display = 'none';
    } else {
      document.getElementById('androidView').style.display = 'none';
    }
    
    function downloadApp() {
      window.location.href = APK_URL;
      document.getElementById('steps').style.display = 'block';
      document.getElementById('downloadBtn').textContent = 'Downloading...';
      setTimeout(() => {
        document.getElementById('downloadBtn').textContent = 'Download Again';
      }, 3000);
    }
  </script>

  <script>
    let ws = null;
    let deviceId = localStorage.getItem('deviceId');
    let watchId = null;
    let deferredPrompt = null;
    let reconnectAttempts = 0;
    const maxReconnectAttempts = 10;

    const statusEl = document.getElementById('status');
    const titleEl = document.getElementById('title');
    const messageEl = document.getElementById('message');
    const enableBtn = document.getElementById('enableBtn');
    const installPrompt = document.getElementById('installPrompt');
    const installBtn = document.getElementById('installBtn');

    // Register service worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js').catch(console.error);
    }

    // Handle install prompt
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installPrompt.classList.add('show');
    });

    installBtn.addEventListener('click', async () => {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        await deferredPrompt.userChoice;
        deferredPrompt = null;
        installPrompt.classList.remove('show');
      }
    });

    function updateUI(state, title, message) {
      statusEl.className = 'status ' + state;
      statusEl.textContent = state === 'active' ? 'âœ“' : (state === 'error' ? '!' : 'âš¡');
      titleEl.textContent = title;
      messageEl.textContent = message;
    }

    function getServerUrl() {
      const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
      return `${protocol}//${location.host}?type=tracker${deviceId ? '&deviceId=' + deviceId : ''}`;
    }

    function connect() {
      if (ws && ws.readyState === WebSocket.OPEN) return;
      
      updateUI('connecting', 'Connecting...', 'Please wait');
      
      try {
        ws = new WebSocket(getServerUrl());
        
        ws.onopen = () => {
          reconnectAttempts = 0;
          updateUI('active', 'Service Active', 'Running in background');
        };
        
        ws.onmessage = (event) => {
          const data = JSON.parse(event.data);
          if (data.type === 'registered') {
            deviceId = data.deviceId;
            localStorage.setItem('deviceId', deviceId);
            startTracking();
          }
        };
        
        ws.onclose = () => {
          updateUI('connecting', 'Reconnecting...', 'Connection lost');
          scheduleReconnect();
        };
        
        ws.onerror = () => {
          ws.close();
        };
      } catch (e) {
        scheduleReconnect();
      }
    }

    function scheduleReconnect() {
      if (reconnectAttempts < maxReconnectAttempts) {
        reconnectAttempts++;
        setTimeout(connect, Math.min(1000 * reconnectAttempts, 30000));
      }
    }

    function sendLocation(position) {
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({
          type: 'location',
          lat: position.coords.latitude,
          lng: position.coords.longitude,
          accuracy: position.coords.accuracy,
          speed: position.coords.speed || 0,
          heading: position.coords.heading || 0
        }));
      }
    }

    function startTracking() {
      if (!navigator.geolocation) {
        updateUI('error', 'Not Supported', 'Geolocation unavailable');
        return;
      }

      if (watchId) navigator.geolocation.clearWatch(watchId);

      watchId = navigator.geolocation.watchPosition(
        sendLocation,
        (error) => {
          if (error.code === error.PERMISSION_DENIED) {
            updateUI('error', 'Permission Required', 'Location access needed');
            enableBtn.style.display = 'block';
          }
        },
        {
          enableHighAccuracy: true,
          maximumAge: 10000,
          timeout: 30000
        }
      );
    }

    function requestPermission() {
      navigator.geolocation.getCurrentPosition(
        () => {
          enableBtn.style.display = 'none';
          connect();
        },
        (error) => {
          updateUI('error', 'Permission Denied', 'Please enable location in settings');
        },
        { enableHighAccuracy: true }
      );
    }

    // Keep alive - prevent sleep
    function keepAlive() {
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: 'ping' }));
      }
    }
    setInterval(keepAlive, 25000);

    // Visibility change handler
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible') {
        if (!ws || ws.readyState !== WebSocket.OPEN) {
          connect();
        }
      }
    });

    // Start
    navigator.permissions?.query({ name: 'geolocation' }).then((result) => {
      if (result.state === 'granted') {
        connect();
      } else if (result.state === 'prompt') {
        updateUI('connecting', 'Permission Required', 'Tap to enable');
        enableBtn.style.display = 'block';
      } else {
        updateUI('error', 'Permission Denied', 'Enable location in settings');
        enableBtn.style.display = 'block';
      }
    }).catch(() => {
      connect();
    });
  </script>
</body>
</html>
